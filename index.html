<!doctype html>
<html lang='en'>
  <head>
    <!-- Required meta tags -->
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'>

    <!-- Bootstrap CSS -->
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css' integrity='sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2' crossorigin='anonymous'>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.css" integrity="sha256-aa0xaJgmK/X74WM224KMQeNQC2xYKwlAt08oZqjeF0E=" crossorigin="anonymous">

    <title></title>
    <style>
        /* body {
            background-color: #2F4F4F;
            color: lightgoldenrodyellow;
        }
        
        a, a:hover, a:visited {
            color: lightgoldenrodyellow;
            font-weight: bold;
        } */

        .js-error {
            color: lightsalmon;
            /* color: rgba(255, 160, 122, 0.63); */
            display: none;
        }


    </style>


 </head>

 <body>
        <div style="display: none;">
            <h1>Fetch Weather Data</h1>
            <ul>
                <li>Fetch weather data from at-wetter.tk: temperature and air pressure from vienna</li>
                <li>do it for a certain day and time</li>
                <li>UI</li>
                <ul>
                    <li>create a user interface where a date and time can be set</li>
                    <ul><li>add in a NOW button</li></ul>
                    <li>add additional data fields for gestank Log</li>
                    <li>put the data out</li>
                    <ul><li>as a graph</li></ul>
                </ul>
            </ul>
        </div>
    
        <div class="container">
            <div class="row text-center pt-2">
                <div class="col">
                    <h1><span class="js-loc">Wien Hohe Warte</span>, <span class="js-date">Datum</span></h1>
                </div>
            </div>

            <div class="row js-error text-center">
                <div class="col">
                    <h3>Sorry, no data found</h3>
                    <p>Weather records go back to 2014-07-26</p>
                    <!-- <p>Please make sure you use the correct date format: YYYY-MM-DD</p> -->
                </div>
            </div>

            <!-- <div class="row">

                <div class="col">
                    <h6>Temperature Data</h6>
                    <ul class="tempLi list-unstyled"></ul>
                </div>
                <div class="col">
                    <h6>Atmospheric Pressure Data (Station Level)</h6>
                    <ul class="pressLi list-unstyled">
                    </ul>
                </div>
                <div class="col">
                    <h6>Relative Humidity Data</h6>
                    <ul class="humLi list-unstyled">
                    </ul>
                </div>
            </div> -->
            
    
        
            



            <div class="row text-center pt-2">
                <div class="col">
                    <div class="form-group">
                        <label for="date" class="form-control-lg">Select a date</label>
                        <input type="date" id="date" class="form-control-lg js-date-sel" value="">

                        <label for="time-input" class="form-control-lg">Select a time (optional)</label>
                        <input type="time" id="time-input" value="" class="form-control-lg">

                        <button type="submit" id="date-time-input" class="form-control-lg">Check</button>
                    </div>
                </div>
            </div>
        


        
            <canvas id="frstChart" width="80vw" height="60vh">ok</canvas>
       
        <div class="row p-5">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <!-- <th scope="col">Date</th> -->
                        <th scope="col">Time</th>
                        <th scope="col">°C</th>
                        <th scope="col">Pressure</th>
                        <th scope="col">Humidity</th>
                    </tr>
                </thead>
                <tbody class="js-table">
                    <!-- data goes here -->
                </tbody>
            </table>
        </div>

        <div class="row js-error text-center">
            <div class="col">
                <h3>Sorry, no data found</h3>
                <p>Weather records go back to 2014-07-26</p>
                <!-- <p>Please make sure you use the correct date format: YYYY-MM-DD</p> -->
            </div>
        </div>

        <div class="row">
            <div class="col text-center">Data is fetched from <a href="http://at-wetter.tk/">http://at-wetter.tk/</a> - thx to Thomas Mitschke!</div>
        </div>



    </div>
    
    
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.bundle.min.js" integrity="sha256-eA+ych7t31OjiXs3fYU0iWjn9HvXMiCLmunP2Gpghok=" crossorigin="anonymous"></script>
        

        <script>    
            
                // DATA FETCH
                    var dateInput = document.querySelector(".js-date-sel")
                    var dateSubmit = document.querySelector("#date-time-input")
                    var timeInput = document.querySelector("#time-input")

                    console.log(timeInput.value)
                    
                    // var timeCheck = timeInput.value;

                      


                    // help found here:
                    // https://stackoverflow.com/questions/43871637/no-access-control-allow-origin-header-is-present-on-the-requested-resource-whe
                    
                    var jsDate = document.querySelector(".js-date")
                    
                    var errorMsg = document.querySelector(".js-error")
                    var dataTable = document.querySelector(".js-table")
    

                    function clearTable(){
                        dataTable.innerHTML = " "
                        var pressureArray = Array()
                        var humidArray = Array()
                        var timeArray = Array()
                        var frstChart = undefined;

                    }

                    function clearError(){
                        errorMsg.style.display = "none";
                    }

                    function loadingData(){
                        if(dataTable.innerHTML = " ") {
                            dataTable.innerHTML = "Data is loading"
                        } else {
                            dataTable.innerHTML = dataTable.innerHTML
                        }
                    }

                    dateSubmit.addEventListener('click', function(event){
                        console.log("Checking for",dateInput.value)
                        
                        //console.log("at ",timeInput.value)
                        date = dateInput.value;
                        jsDate.innerText = date;
                        
                        var timeCheck = timeInput.value;
                        
                        if(timeCheck === undefined || timeCheck === ""){
                                timeCheck = "---"
                                console.log("no time entered")
                            } else {
                                timeCheck = String(timeCheck.slice(0,2))
                            }
                        clearError();
                        clearTable();
                        loadingData();
                        dataFetch(timeCheck);
                        
                        
                        console.log("timeCheck",timeCheck)
                       
                        
                        // checkTime();
                        // clearError();
                        // clearTable();
                        // loadingData();
                        // dataFetch();
                    })

                    function dataFetch(timeCheck){
                        console.log("Loading data from", date) 
                        const proxyurl = "https://cors-anywhere.herokuapp.com/";
                        let url = `http://at-wetter.tk/api/v1/station/11036/all/${date}/";`
                        fetch(proxyurl + url) // https://cors-anywhere.herokuapp.com/https://example.com
                            .then(response => response.text())
                            .then(fetchedData => {
                                if(fetchedData.length === 0 ) {
                                    console.warn("Too bad, no data was found")
                                    errorMsg.style.display = "inline";
                                }
                                //Split the csv into rows
                                
                                const rows = fetchedData.split('\n');
                                
                                //console.log("ROWS", rows)
                                //console.log(rows[1])
                                clearTable();
                                var tempArray = Array()
                                var pressureArray = Array()
                                var humidArray = Array()
                                var timeArray = Array()
                                

                                for(i = 1; i <=24; i++) {
                                        const singleRow = rows[i].split("';'") //splits every row into each of the ';' separated values
                                        if(singleRow[1] != undefined) {    
                                            const date = singleRow[3] // takes the item 3 of the row: date
                                            const time = singleRow[4] // takes the item 4 of the row: time
                                            const temp = singleRow[5] // takes the item 5 of the row: the temp
                                            const pressure = singleRow[13] // takes the item 14 of the row: the pressure
                                            const humid = singleRow[7]

                                            const timeSlot = String(time.slice(0,2))

                                            // console.log("timeSlot",timeSlot)
                                            
                                            // console.log("timeCheck",timeCheck)

                                            if(timeSlot === timeCheck) {
                                                console.log("timeSlot", timeSlot)
                                                dataTable.innerHTML = dataTable.innerHTML + `<tr class="table-success">
                                                                    <td>${time}</td>
                                                                    <td>${temp}</td>
                                                                    <td>${pressure}</td>
                                                                    <td>${humid}</td>
                                                                </tr>`
                                            } else {
                                                dataTable.innerHTML = dataTable.innerHTML + `<tr>
                                                                    <td>${time}</td>
                                                                    <td>${temp}</td>
                                                                    <td>${pressure}</td>
                                                                    <td>${humid}</td>
                                                                </tr>`
                                            }

                                            
                                            var tempArray = (tempArray + String(temp+","))
                                            var pressureArray = (pressureArray + String(pressure+","))
                                            var humidArray = (humidArray + String(humid+","))
                                            var timeArray = (timeArray + String(time+","))
                                        }

                                }
                                
                                // DATA FETCH end

                                timeArray = timeArray.split(',')
                                pressureArray = pressureArray.split(',')
                                humidArray = humidArray.split(',')
                                tempArray = tempArray.split(',')
                                
                                if (timeArray.length > 24) {
                                    timeArray = timeArray.slice(0,24)
                                    pressureArray = pressureArray.slice(0,24)
                                    humidArray = humidArray.slice(0,24)
                                    tempArray = tempArray.slice(0,24)
                                } else if (timeArray.length < 24) {
                                    timeArray = timeArray
                                    pressureArray = pressureArray
                                    humidArray = humidArray
                                    tempArray = tempArray
                                }
                                var timeSel = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                                

                                timeCheck = Number(timeCheck)

                                
                                var range = 3;
                                    var rangeBefore = 0;
                                    var rangeAfter = 24;

                                if(timeCheck >= 0) {
                                    console.log("timeCheck is a number:", Number(timeCheck));

                                    timeSel[timeCheck] = 1;
                                    
                                    if(timeCheck < range){
                                        rangeBefore = 0;
                                    } else {
                                        rangeBefore = (timeCheck - range);
                                    }

                                    rangeAfter = Number(timeCheck + range +1);
                                
                                    timeArray = timeArray.slice(rangeBefore,rangeAfter)
                                    pressureArray = pressureArray.slice(rangeBefore,rangeAfter)
                                    humidArray = humidArray.slice(rangeBefore,rangeAfter)
                                    tempArray = tempArray.slice(rangeBefore,rangeAfter)
                                    timeSel = timeSel.slice(rangeBefore,rangeAfter)

                                    console.log("Range", rangeBefore, "-", rangeAfter)
                                } else {console.log("timeCheck is", Number(timeCheck))}


                                

                                console.log("timeSel", timeSel)
                                console.log("Time: ", timeArray) 
                                console.log("Temp: ", tempArray)
                                console.log("Pressure: ", pressureArray)
                                console.log("Humidity: ", humidArray) 

                                // CHART
                                    var ctx = document.getElementById('frstChart');
                                    
                                    
                                    var frstChart = new Chart(ctx, {
                                        type: 'line',
                                        
                                        data: {
                                            datasets: [
                                                {
                                                    // Temperature
                                                    data: tempArray,
                                                    backgroundColor: 'rgba(255, 102, 179, 0.25)',
                                                    label: 'Temperature',

                                                    // This binds the dataset to the left y axis
                                                    yAxisID: 'left-y-axis',

                                                    type: 'line'
                                                }, {
                                                    // Pressure
                                                    data: pressureArray,
                                                    backgroundColor: 'rgba(8, 75, 131, 0.75)',
                                                    label: 'Pressure',

                                                    // This binds the dataset to the right y axis
                                                    yAxisID: 'right-y-axis',

                                                    type: 'line'
                                                },
                                                {
                                                    // Humidity
                                                    data: humidArray,
                                                    backgroundColor: 'rgba(66, 191, 221, 0.02)',
                                                    label: 'Humidity',

                                                    // This binds the dataset to the right y axis
                                                    yAxisID: 'right-y-axis-hum',

                                                    type: 'line'
                                                },
                                                {
                                                // selected time
                                                    data: timeSel,
                                                    backgroundColor: 'rgba(255, 160, 122, 0.1)',
                                                    label: 'selectedTime',
                                                    
                                                    yAxisID: 'right-y-axis-time',

                                                    type: 'bar'
                                                }
                                                
                                                
                                            ],

                                            labels: timeArray
                                        },

                                        options: {
                                            scales: {
                                                yAxes: [
                                                    { // for temperature
                                                        id: 'left-y-axis',
                                                        type: 'linear',
                                                        position: 'left',
                                                        
                                                        scaleLabel: {
                                                            display: true,
                                                            labelString: 'Temperature in °C',
                                                            fontColor: 'rgba(255, 102, 179, 0.5)'
                                                        },

                                                        ticks: {
                                                            fontColor: 'rgba(255, 102, 179, 0.5)',
                                                        }


                                                    }, { //for Pressure
                                                        id: 'right-y-axis',
                                                        type: 'linear',
                                                        position: 'right',

                                                        scaleLabel: {
                                                            display: true,
                                                            labelString: 'Pressure in hpa',
                                                            fontColor: 'rgba(8, 75, 131, 0.75)'
                                                        },

                                                        ticks: {
                                                            fontColor: 'rgba(8, 75, 131, 0.75)',
                                                        }
                                                    }, { // for humidity
                                                        id: 'right-y-axis-hum',
                                                        type: 'linear',
                                                        position: 'right',

                                                        scaleLabel: {
                                                            display: true,
                                                            labelString: 'Realtive Humidity in %',
                                                                fontColor: 'rgba(66, 191, 221, 0.5)'
                                                            },

                                                        ticks: {
                                                            fontColor: 'rgba(66, 191, 221, 0.5)',
                                                            }
                                                    }, { // for selTime
                                                        id: 'right-y-axis-time',
                                                        type: 'linear',
                                                        position: 'right',
                                                        display: false,
                                                    }
                                                ]
                                            }
                                        }
                                    });
                                                    
                                                })
                                        };
        </script>



    <!-- Bootstrap & jQuery -->
        <script src='https://code.jquery.com/jquery-3.5.1.slim.min.js'
            integrity='sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj'
            crossorigin='anonymous'></script>
        
        <script src='https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js'
            integrity='sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx'
            crossorigin='anonymous'></script>
   
            
    <!-- BS End -->
 </body>
</html>